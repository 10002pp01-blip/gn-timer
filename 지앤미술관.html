<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>지앤미술관</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">


<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
html,body{
  margin:0;padding:0;
  background:#000;color:#fff;
  font-family:sans-serif;
}
h1{
  text-align:center;
  font-size:20px;
  margin:6px 0;
}
#rooms{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  padding:10px;
}
.room{
  background:#111;
  border:3px solid #333;
  border-radius:14px;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.room h3{margin:0;text-align:center;}
.time{
  font-size:26px;
  text-align:center;
  font-weight:bold;
}
.starttime{
  text-align:center;
  background:#222;
  border-radius:10px;
  padding:6px;
}
.buttons{display:flex;gap:6px;}
button{
  flex:1;
  font-size:16px;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:bold;
}
.start{background:#ff9800;color:#000;}
.extend{background:#4caf50;}
.cancel{background:#f44336;}
#timePicker{
  display:none;
  position:fixed;
  inset:0;
  background:#000c;
}
#pickerBox{
  background:#222;
  margin:30% auto;
  width:280px;
  padding:20px;
  border-radius:16px;
  text-align:center;
}
#pickerBox select{font-size:28px;}
#pickerBox button{font-size:20px;margin:6px;}
</style>
</head>

<body>

<h1>지앤미술관</h1>
<div id="rooms"></div>

<div id="timePicker">
  <div id="pickerBox">
    <select id="pickHour"></select> :
    <select id="pickMin"></select><br><br>
    <button onclick="applyTime()">적용</button>
    <button onclick="closePicker()">취소</button>
  </div>
</div>

<script>
/* ===== 화면 유지 ===== */
let wakeLock=null;
document.addEventListener('touchstart',async()=>{
  try{wakeLock=await navigator.wakeLock.request('screen')}catch{}
},{once:true});

/* ===== 설정 ===== */
const ROOM_COUNT=9;
const BASE_TIME=120*60*1000;
const WARN_BEFORE=10*60*1000;
const EXTEND_TIME=60*60*1000;

const rooms={};
let editingRoom=null;

/* ===== 음성 ===== */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang="ko-KR";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== 저장/복원 ===== */
function saveState(){
  localStorage.setItem("rooms_state",JSON.stringify(rooms));
}
function loadState(){
  const data=localStorage.getItem("rooms_state");
  if(!data)return;
  const saved=JSON.parse(data);
  for(const n in saved){
    const r=saved[n];
    if(r.endTime<=Date.now())continue;
    rooms[n]={
      startTime:r.startTime,
      endTime:r.endTime,
      warned:r.warned||false,
      timer:setInterval(()=>updateRoom(n),1000)
    };
    updateStartLabel(n,r.startTime);
  }
}

/* ===== 시간 ===== */
function format(ms){
  if(ms<0)ms=0;
  const t=Math.floor(ms/1000);
  return `${String(Math.floor(t/3600)).padStart(2,'0')}:${String(Math.floor(t%3600/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;
}

/* ===== 시작 ===== */
function startRoom(n,startTime=null){
  if(rooms[n]){
    speak("이미 진행중입니다");
    return;
  }
  const st=startTime??Date.now();
  rooms[n]={
    startTime:st,
    endTime:st+BASE_TIME,
    warned:false,
    timer:setInterval(()=>updateRoom(n),1000)
  };
  updateStartLabel(n,st);
  speak(`${n}번 룸이 시작되었습니다`);
  saveState();
}

/* ===== 연장 ===== */
function extendRoom(n){
  if(!rooms[n])return;
  rooms[n].endTime+=EXTEND_TIME;
  speak(`${n}번 룸 1시간 연장되었습니다`);
  saveState();
}

/* ===== 취소 ===== */
function cancelRoom(n,voice=true){
  if(!rooms[n])return;
  clearInterval(rooms[n].timer);
  delete rooms[n];
  document.getElementById(`time${n}`).textContent="대기";
  document.getElementById(`start${n}`).textContent="시작시간 --:--";
  if(voice)speak(`${n}번 룸이 취소되었습니다`);
  saveState();
}

/* ===== 업데이트 ===== */
function updateRoom(n){
  const r=rooms[n];
  if(!r)return;
  const remain=r.endTime-Date.now();
  document.getElementById(`time${n}`).textContent=format(remain);

  if(!r.warned&&remain<=WARN_BEFORE){
    r.warned=true;
    speak(`${n}번 룸 마감 10분 전입니다`);
  }
  if(remain<=0){
    speak(`${n}번 룸 시간이 종료되었습니다`);
    cancelRoom(n,false);
  }
}

/* ===== 시간 수정 ===== */
function openTimePicker(n){
  editingRoom=n;
  const d=rooms[n]?new Date(rooms[n].startTime):new Date();
  let h=d.getHours()%12||12;
  pickHour.value=h;
  pickMin.value=String(d.getMinutes()).padStart(2,'0');
  timePicker.style.display="block";
}
function closePicker(){timePicker.style.display="none";}
function applyTime(){
  const h=parseInt(pickHour.value)%12;
  const m=parseInt(pickMin.value);
  const now=new Date();
  let d=new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0);
  if(d>now)d.setHours(d.getHours()-12);

  if(rooms[editingRoom]){
    const r=rooms[editingRoom];
    r.startTime=d.getTime();
    r.endTime=r.startTime+BASE_TIME;
    r.warned=false;
    updateStartLabel(editingRoom,r.startTime);
  }else{
    startRoom(editingRoom,d.getTime());
  }
  speak(`${editingRoom}번 룸 시간이 수정되었습니다`);
  saveState();
  closePicker();
}

/* ===== 시작시간 표시 ===== */
function updateStartLabel(n,ts){
  const d=new Date(ts);
  let h=d.getHours()%12||12;
  const m=d.getMinutes();
  document.getElementById(`start${n}`).textContent=`시작시간 ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

/* ===== UI ===== */
const roomsDiv=document.getElementById("rooms");
for(let i=1;i<=ROOM_COUNT;i++){
  roomsDiv.innerHTML+=`
  <div class="room">
    <h3>${i}번</h3>
    <div class="time" id="time${i}">대기</div>
    <div class="starttime" id="start${i}" onclick="openTimePicker(${i})">시작시간 --:--</div>
    <div class="buttons">
      <button class="start" onclick="startRoom(${i})">시작</button>
      <button class="extend" onclick="extendRoom(${i})">+1h</button>
      <button class="cancel" onclick="cancelRoom(${i})">취소</button>
    </div>
  </div>`;
}
for(let i=1;i<=12;i++)pickHour.innerHTML+=`<option>${i}</option>`;
for(let i=0;i<60;i++)pickMin.innerHTML+=`<option>${String(i).padStart(2,'0')}</option>`;

window.addEventListener("load",loadState);
</script>
</body>
</html>
